<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Firebase Storage Direct</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
        }
        .success { background: #e8f5e8; color: #2e7d32; }
        .error { background: #ffebee; color: #c62828; }
        .info { background: #e3f2fd; color: #1565c0; }
    </style>
</head>
<body>
    <h1>üß™ Test Firebase Storage</h1>
    <div id="results"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getStorage, ref, listAll, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        import { getFirestore, collection, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const resultsEl = document.getElementById('results');

        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            resultsEl.appendChild(div);
        }

        async function testFirebaseStorage() {
            try {
                // Firebase config from your project
                const firebaseConfig = {
                    apiKey: "AIzaSyDHi_a1trI35goPoKcNPUDBMOSLKjvZKyc",
                    authDomain: "cms-menu-7b4a4.firebaseapp.com",
                    projectId: "cms-menu-7b4a4",
                    storageBucket: "cms-menu-7b4a4.firebasestorage.app",
                    messagingSenderId: "509736809578",
                    appId: "1:509736809578:web:15471af092f3b46392c613",
                    measurementId: "G-X4F9XDEL13"
                };

                addResult('üîÑ Initializing Firebase...', 'info');
                const app = initializeApp(firebaseConfig);
                const storage = getStorage(app);
                const db = getFirestore(app);
                
                addResult('‚úÖ Firebase initialized successfully', 'success');

                const businessId = "HsuTZWhRVkT88a0WOztELGzJUhl1";
                
                // Test 1: Check if businesses collection exists
                addResult('üîç Testing Firestore access...', 'info');
                const businessRef = doc(db, 'businesses', businessId);
                const businessDoc = await getDoc(businessRef);
                
                if (businessDoc.exists()) {
                    addResult('‚úÖ Business document found in Firestore', 'success');
                } else {
                    addResult('‚ö†Ô∏è Business document not found, trying restaurants collection...', 'error');
                    const restaurantRef = doc(db, 'restaurants', businessId);
                    const restaurantDoc = await getDoc(restaurantRef);
                    if (restaurantDoc.exists()) {
                        addResult('‚úÖ Found in restaurants collection (compatibility mode)', 'success');
                    } else {
                        addResult('‚ùå Business not found in either collection', 'error');
                    }
                }

                // Test 2: List storage buckets content
                addResult('üîç Testing Firebase Storage access...', 'info');
                
                // Try different possible paths where images might be stored
                const possiblePaths = [
                    `businesses/${businessId}`,
                    `restaurants/${businessId}`,
                    'items',
                    'categories'
                ];

                for (const path of possiblePaths) {
                    try {
                        addResult(`üîç Checking storage path: ${path}`, 'info');
                        const pathRef = ref(storage, path);
                        const listResult = await listAll(pathRef);
                        
                        if (listResult.items.length > 0) {
                            addResult(`‚úÖ Found ${listResult.items.length} files in ${path}`, 'success');
                            
                            // Try to get download URL for first image
                            const firstItem = listResult.items[0];
                            try {
                                const downloadURL = await getDownloadURL(firstItem);
                                addResult(`‚úÖ Successfully got download URL: ${downloadURL}`, 'success');
                                
                                // Test if image actually loads
                                const img = new Image();
                                img.onload = () => addResult(`‚úÖ Image loads successfully: ${firstItem.name}`, 'success');
                                img.onerror = () => addResult(`‚ùå Image failed to load: ${firstItem.name}`, 'error');
                                img.src = downloadURL;
                                
                            } catch (urlError) {
                                addResult(`‚ùå Failed to get download URL: ${urlError.message}`, 'error');
                            }
                        } else if (listResult.prefixes.length > 0) {
                            addResult(`üìÅ Found ${listResult.prefixes.length} subdirectories in ${path}`, 'info');
                        } else {
                            addResult(`‚ö†Ô∏è No files found in ${path}`, 'error');
                        }
                    } catch (pathError) {
                        addResult(`‚ùå Error accessing ${path}: ${pathError.message}`, 'error');
                    }
                }

                // Test 3: Get actual menu data and check image fields
                addResult('üçΩÔ∏è Testing menu data and image fields...', 'info');
                try {
                    // Try businesses first
                    let menuRef = collection(db, 'businesses', businessId, 'menu');
                    let menuSnapshot = await getDocs(menuRef);
                    
                    if (menuSnapshot.empty) {
                        addResult('üìç Trying restaurants collection for menu...', 'info');
                        menuRef = collection(db, 'restaurants', businessId, 'menu');
                        menuSnapshot = await getDocs(menuRef);
                    }

                    if (menuSnapshot.empty) {
                        addResult('‚ùå No menu categories found', 'error');
                    } else {
                        addResult(`‚úÖ Found ${menuSnapshot.size} menu categories`, 'success');
                        
                        for (const categoryDoc of menuSnapshot.docs) {
                            const categoryData = categoryDoc.data();
                            addResult(`üìÇ Category: ${categoryData.name}`, 'info');
                            
                            // Get items in this category
                            const itemsRef = collection(categoryDoc.ref, 'items');
                            const itemsSnapshot = await getDocs(itemsRef);
                            
                            addResult(`üìã Items in ${categoryData.name}: ${itemsSnapshot.size}`, 'info');
                            
                            itemsSnapshot.docs.forEach(itemDoc => {
                                const itemData = itemDoc.data();
                                addResult(`üçî Item: ${itemData.name} | Image field: ${itemData.image || 'NOT FOUND'} | Has image: ${!!itemData.image}`, itemData.image ? 'success' : 'error');
                            });
                        }
                    }
                } catch (menuError) {
                    addResult(`‚ùå Error fetching menu: ${menuError.message}`, 'error');
                }

            } catch (error) {
                addResult(`‚ùå Fatal error: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        testFirebaseStorage();
    </script>
</body>
</html>
